<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDM Filament Finder</title>
    <!-- 1. Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Load Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* 3. Set base font and dark mode */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            /* bg-gray-900 */
            color: #f3f4f6;
            /* text-gray-100 */
        }

        /* Simple styling for range slider thumbs */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6;
            /* bg-blue-500 */
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            /* bg-blue-500 */
            border-radius: 50%;
            cursor: pointer;
        }

        /* Modal styling */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
        }

        .modal-content {
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-content::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .modal-content::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>

<body class="antialiased">

    <div class="container mx-auto max-w-7xl p-4 sm:p-6 lg:p-8">

        <!-- Header -->
        <header class="mb-8">
            <div class="flex items-center justify-between mb-2">
                <h1 class="text-4xl font-bold text-white">FDM Filament Finder</h1>
                <span class="text-sm font-medium text-gray-400 bg-gray-800 px-3 py-1 rounded-full">v1.4.0</span>
            </div>
            <p class="text-lg text-gray-300">Select your desired properties to find the perfect material for your
                project.</p>
        </header>

        <!-- Main Content: Filters + Results -->
        <div class="flex flex-col lg:flex-row gap-8">

            <!-- Filters Column -->
            <aside class="w-full lg:w-1/3 xl:w-1/4">
                <div class="sticky top-8 bg-gray-800 p-6 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6 border-b border-gray-600 pb-3">
                        <h2 class="text-2xl font-semibold text-white">Filters</h2>
                        <button id="reset-filters-btn" onclick="resetAllFilters()" class="text-sm px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white rounded-lg transition-colors flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Reset
                        </button>
                    </div>

                    <!-- Filter Presets -->
                    <div class="space-y-3 mb-6 pb-6 border-b border-gray-600">
                        <h3 class="text-lg font-medium text-gray-100">Quick Presets</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="applyPreset('beginner')" class="text-xs px-3 py-2 bg-green-700 hover:bg-green-600 text-white rounded-lg transition-colors">
                                üå± Beginner
                            </button>
                            <button onclick="applyPreset('outdoor')" class="text-xs px-3 py-2 bg-yellow-700 hover:bg-yellow-600 text-white rounded-lg transition-colors">
                                ‚òÄÔ∏è Outdoor
                            </button>
                            <button onclick="applyPreset('engineering')" class="text-xs px-3 py-2 bg-blue-700 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                üîß Engineering
                            </button>
                            <button onclick="applyPreset('flexible')" class="text-xs px-3 py-2 bg-pink-700 hover:bg-pink-600 text-white rounded-lg transition-colors">
                                üîÑ Flexible
                            </button>
                        </div>
                    </div>

                    <!-- Boolean Checkboxes -->
                    <div id="filter-checkboxes" class="space-y-4 mb-6">
                        <h3 class="text-lg font-medium text-gray-100">Key Attributes</h3>
                        <label class="flex items-center space-x-3 select-none cursor-pointer">
                            <input type="checkbox" id="filter-uv" data-key="UV_Resistant" data-value="true"
                                class="form-checkbox h-5 w-5 text-blue-500 rounded bg-gray-700 border-gray-600 focus:ring-blue-600">
                            <span class="text-gray-200">UV Resistant</span>
                        </label>
                        <label class="flex items-center space-x-3 select-none cursor-pointer">
                            <input type="checkbox" id="filter-moisture" data-key="Hygroscopic" data-value="false"
                                class="form-checkbox h-5 w-5 text-blue-500 rounded bg-gray-700 border-gray-600 focus:ring-blue-600">
                            <span class="text-gray-200">Low Moisture Sensitivity</span>
                        </label>
                        <label class="flex items-center space-x-3 select-none cursor-pointer">
                            <input type="checkbox" id="filter-enclosure" data-key="Requires_Enclosure"
                                data-value="false"
                                class="form-checkbox h-5 w-5 text-blue-500 rounded bg-gray-700 border-gray-600 focus:ring-blue-600">
                            <span class="text-gray-200">No Enclosure Required</span>
                        </label>
                        <label class="flex items-center space-x-3 select-none cursor-pointer">
                            <input type="checkbox" id="filter-fumes" data-key="Releases_Fumes" data-value="false"
                                class="form-checkbox h-5 w-5 text-blue-500 rounded bg-gray-700 border-gray-600 focus:ring-blue-600">
                            <span class="text-gray-200">Low/No Fumes</span>
                        </label>
                        <label class="flex items-center space-x-3 select-none cursor-pointer">
                            <input type="checkbox" id="filter-friction" data-key="Low_Friction" data-value="true"
                                class="form-checkbox h-5 w-5 text-blue-500 rounded bg-gray-700 border-gray-600 focus:ring-blue-600">
                            <span class="text-gray-200">Low Friction</span>
                        </label>
                        <label class="flex items-center space-x-3 select-none cursor-pointer">
                            <input type="checkbox" id="filter-abrasive" data-key="Requires_Hardened_Nozzle"
                                data-value="false"
                                class="form-checkbox h-5 w-5 text-blue-500 rounded bg-gray-700 border-gray-600 focus:ring-blue-600">
                            <span class="text-gray-200">Not Abrasive</span>
                        </label>
                    </div>

                    <!-- Nozzle Type Selection -->
                    <div id="filter-nozzle" class="space-y-4 mb-6 pt-4 border-t border-gray-600">
                        <h3 class="text-lg font-medium text-gray-100">Nozzle Type</h3>
                        <p class="text-xs text-gray-400 mb-3">Select your nozzle type to filter compatible materials</p>
                        <select id="nozzle-select" class="w-full bg-gray-700 border border-gray-600 text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
                            <option value="all">All Nozzles</option>
                            <option value="brass">Brass (Standard)</option>
                            <option value="hardened-steel">Hardened Steel</option>
                            <option value="ruby">Ruby Tipped</option>
                            <option value="stainless-steel">Stainless Steel</option>
                        </select>
                        <div id="nozzle-info" class="text-xs text-gray-400 mt-2 p-2 bg-gray-700 rounded hidden"></div>
                    </div>

                    <!-- Display Options -->
                    <div id="display-options" class="space-y-3 mb-6 pt-4 border-t border-gray-600">
                        <h3 class="text-lg font-medium text-gray-100">Display Options</h3>
                        <label class="flex items-center space-x-3 select-none cursor-pointer">
                            <input type="checkbox" id="toggle-annealed"
                                   class="form-checkbox h-5 w-5 text-blue-500 rounded bg-gray-700 border-gray-600 focus:ring-blue-600">
                            <span class="text-gray-200">Show Annealed Properties (where available)</span>
                        </label>
                        <p class="text-xs text-gray-400">Uses annealed strength and HDT when available.</p>
                    </div>

                    <!-- Range Sliders -->
                    <div id="filter-sliders" class="space-y-6">
                        <h3 class="text-lg font-medium text-gray-100">Performance (Minimum)</h3>

                        <div>
                            <label for="filter-printability"
                                class="flex justify-between text-sm font-medium text-gray-200 mb-1"
                                title="How easy the material is to print. 10 = easiest (beginner-friendly), 1 = most difficult (requires expertise)">
                                <span class="cursor-help">Printability ‚ìò</span>
                                <span id="val-printability" class="font-bold">1</span>
                            </label>
                            <div class="flex gap-2 items-center">
                                <input type="range" id="filter-printability" data-key="Printability_Score" min="1" max="10"
                                    value="1" class="flex-grow h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                    title="Filter for materials with this printability rating or higher">
                                <input type="number" id="input-printability" min="1" max="10" value="1"
                                    class="w-16 px-2 py-1 text-sm bg-gray-700 border border-gray-600 rounded text-gray-100 text-center focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div>
                            <label for="filter-strength"
                                class="flex justify-between text-sm font-medium text-gray-200 mb-1"
                                title="Tensile strength in the XY plane (along print layers). Higher values = stronger parts that resist breaking under tension">
                                <span class="cursor-help">Strength (XY MPa) ‚ìò</span>
                                <span id="val-strength" class="font-bold">0</span>
                            </label>
                            <div class="flex gap-2 items-center">
                                <input type="range" id="filter-strength" data-key="Strength_XY_MPa" min="0" max="150"
                                    value="0" class="flex-grow h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                    title="Filter for materials with this strength or higher. Typical values: PLA ~65 MPa, PETG ~50 MPa, Nylon ~75 MPa">
                                <input type="number" id="input-strength" min="0" max="150" value="0"
                                    class="w-16 px-2 py-1 text-sm bg-gray-700 border border-gray-600 rounded text-gray-100 text-center focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div>
                            <label for="filter-heat"
                                class="flex justify-between text-sm font-medium text-gray-200 mb-1"
                                title="Heat Deflection Temperature - the temperature at which the material begins to deform under load. Higher values = better heat resistance">
                                <span class="cursor-help">Heat Resistance (HDT ¬∞C) ‚ìò</span>
                                <span id="val-heat" class="font-bold">0</span>
                            </label>
                            <div class="flex gap-2 items-center">
                                <input type="range" id="filter-heat" data-key="Heat_Resistance_HDT_C" min="0" max="250"
                                    value="0" class="flex-grow h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                    title="Filter for materials that can withstand this temperature or higher. Examples: PLA ~56¬∞C, PETG ~70¬∞C, ABS ~87¬∞C, PC ~113¬∞C">
                                <input type="number" id="input-heat" min="0" max="250" value="0"
                                    class="w-16 px-2 py-1 text-sm bg-gray-700 border border-gray-600 rounded text-gray-100 text-center focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div class="mt-1 flex flex-wrap gap-1">
                                <button onclick="snapToValue('heat', 0)" class="px-2 py-0.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">0¬∞</button>
                                <button onclick="snapToValue('heat', 50)" class="px-2 py-0.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">50¬∞</button>
                                <button onclick="snapToValue('heat', 60)" class="px-2 py-0.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">60¬∞</button>
                                <button onclick="snapToValue('heat', 70)" class="px-2 py-0.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">70¬∞</button>
                                <button onclick="snapToValue('heat', 80)" class="px-2 py-0.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">80¬∞</button>
                                <button onclick="snapToValue('heat', 100)" class="px-2 py-0.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">100¬∞</button>
                                <button onclick="snapToValue('heat', 150)" class="px-2 py-0.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">150¬∞</button>
                                <button onclick="snapToValue('heat', 200)" class="px-2 py-0.5 text-xs bg-gray-700 hover:bg-gray-600 text-gray-300 rounded">200¬∞</button>
                            </div>
                        </div>

                        <div>
                            <label for="filter-cost"
                                class="flex justify-between text-sm font-medium text-gray-200 mb-1"
                                title="Cost rating where 10 = least expensive, 1 = most expensive. This is a relative score, not actual price">
                                <span class="cursor-help">Max Cost Score ‚ìò</span>
                                <span id="val-cost" class="font-bold">10</span>
                            </label>
                            <div class="flex gap-2 items-center">
                                <input type="range" id="filter-cost" data-key="Cost_Score" min="1" max="10" value="10"
                                    class="flex-grow h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer"
                                    title="Filter for materials at or below this cost level. 10 = budget-friendly, 1 = premium materials">
                                <input type="number" id="input-cost" min="1" max="10" value="10"
                                    class="w-16 px-2 py-1 text-sm bg-gray-700 border border-gray-600 rounded text-gray-100 text-center focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Results Column -->
            <main class="w-full lg:w-2/3 xl:w-3/4">
                <div class="mb-4">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-2">
                        <div class="flex items-center gap-4">
                            <h2 class="text-2xl font-semibold text-white">Recommended Materials</h2>
                            <span id="results-count" class="text-lg text-gray-400 font-medium"></span>
                        </div>
                        <div class="flex items-center gap-2">
                            <label for="sort-select" class="text-sm text-gray-300 font-medium mr-2">Sort by:</label>
                            <select id="sort-select" class="bg-gray-800 border border-gray-700 text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-2.5">
                                <option value="printability">Printability (High ‚Üí Low)</option>
                                <option value="strength">Strength (High ‚Üí Low)</option>
                                <option value="heat">Heat Resistance (High ‚Üí Low)</option>
                                <option value="cost">Cost (Low ‚Üí High)</option>
                                <option value="name">Material Name (A ‚Üí Z)</option>
                            </select>
                            <!-- View Mode Toggle -->
                            <div class="hidden md:flex items-center gap-1 ml-2" aria-label="View mode">
                                <button id="view-detailed-btn" class="px-3 py-1.5 text-xs rounded-l-lg bg-blue-600 text-white border border-blue-500 hover:bg-blue-500 transition-colors">Detailed</button>
                                <button id="view-compact-btn" class="px-3 py-1.5 text-xs rounded-r-lg bg-gray-700 text-gray-100 border border-gray-600 hover:bg-gray-600 transition-colors">Compact</button>
                            </div>
                        </div>
                    </div>
                    <!-- Search Bar -->
                    <div class="relative mb-4">
                        <input type="text" id="material-search" placeholder="Search materials by name or category..." 
                               class="w-full bg-gray-800 border border-gray-700 text-gray-100 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 pl-10 p-3">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                            <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                <div id="results-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    <!-- Results will be injected here by JavaScript -->
                </div>
                <div id="no-results" class="hidden text-center text-gray-400 text-xl py-16">
                    <p>No materials match your criteria.</p>
                    <p class="text-base">Try adjusting your filters.</p>
                </div>

                <!-- Compare Bar (appears when 2-4 materials selected) -->
                <div id="compare-bar" class="hidden mt-6 p-3 bg-gray-800 border border-gray-700 rounded-lg flex items-center justify-between">
                    <div class="text-sm text-gray-200">
                        <span id="compare-count" class="font-semibold">0</span> selected for comparison (max 4)
                    </div>
                    <div class="flex gap-2">
                        <button id="compare-btn" class="px-3 py-1.5 text-sm rounded-lg bg-blue-600 hover:bg-blue-500 text-white border border-blue-500">Compare</button>
                        <button id="clear-compare-btn" class="px-3 py-1.5 text-sm rounded-lg bg-gray-700 hover:bg-gray-600 text-gray-100 border border-gray-600">Clear</button>
                    </div>
                </div>

                <!-- Compare View Table -->
                <div id="compare-view" class="hidden mt-6 bg-gray-800 border border-gray-700 rounded-xl overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-3 border-b border-gray-700">
                        <h3 class="text-lg font-semibold text-white flex items-center">
                            Comparison
                            <span id="compare-mode-hint" class="ml-2 text-[11px] px-2 py-0.5 rounded-full border hidden bg-amber-900/40 text-amber-200 border-amber-700">Dual view: As‚ÄëPrinted + Annealed</span>
                        </h3>
                        <button id="close-compare-btn" class="px-3 py-1.5 text-sm rounded-lg bg-gray-700 hover:bg-gray-600 text-gray-100 border border-gray-600">Close</button>
                    </div>
                    <div id="compare-table-wrapper" class="overflow-x-auto">
                        <table class="min-w-full text-sm text-left text-gray-300">
                            <thead class="bg-gray-900 text-gray-200">
                                <tr>
                                    <th class="px-4 py-2">Property</th>
                                    <th class="px-4 py-2">Material 1</th>
                                    <th class="px-4 py-2">Material 2</th>
                                    <th class="px-4 py-2">Material 3</th>
                                    <th class="px-4 py-2">Material 4</th>
                                </tr>
                            </thead>
                            <tbody id="compare-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>

        <!-- Footer / Reference Section -->
        <footer class="mt-16 pt-8 border-t border-gray-700">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                <!-- About Section -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-3">About This Tool</h3>
                    <p class="text-sm text-gray-400 mb-3">
                        An intelligent material selection assistant for FDM 3D printing, helping you choose the right filament based on your project requirements.
                    </p>
                    <p class="text-xs text-gray-500">
                        Built with comprehensive data from technical data sheets, engineering handbooks, and real-world testing.
                    </p>
                </div>

                <!-- Quick Links -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-3">Documentation</h3>
                    <ul class="space-y-2 text-sm text-gray-400">
                        <li>
                            <a href="README.md" class="hover:text-blue-400 transition-colors flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                README - User Guide
                            </a>
                        </li>
                        <li>
                            <a href="CHANGELOG.md" class="hover:text-blue-400 transition-colors flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                Changelog - Version History
                            </a>
                        </li>
                        <li>
                            <a href="TODO.md" class="hover:text-blue-400 transition-colors flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path>
                                </svg>
                                Roadmap - Future Features
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/minimal3dp/m3dp-filament-recommendation-engine" target="_blank" class="hover:text-blue-400 transition-colors flex items-center">
                                <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                </svg>
                                GitHub Repository
                            </a>
                        </li>
                    </ul>
                </div>

                <!-- Data Sources & Credits -->
                <div>
                    <h3 class="text-lg font-bold text-white mb-3">Data Sources</h3>
                    <ul class="space-y-2 text-xs text-gray-400">
                        <li class="flex items-start">
                            <span class="mr-2 mt-0.5">üìä</span>
                            <span><strong>Material Database:</strong> 40 FDM materials with 26+ properties each</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2 mt-0.5">üìÑ</span>
                            <span><strong>Technical Data Sheets:</strong> Manufacturer specifications and test data</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2 mt-0.5">üî¨</span>
                            <span><strong>Engineering References:</strong> Material science handbooks and standards</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2 mt-0.5">üõ†Ô∏è</span>
                            <span><strong>Nozzle Guide:</strong> Compatibility testing and wear characteristics</span>
                        </li>
                        <li class="flex items-start">
                            <span class="mr-2 mt-0.5">üñ®Ô∏è</span>
                            <span><strong>Printer Report 2024-2025:</strong> Hardware capabilities database</span>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Bottom Bar -->
            <div class="pt-6 border-t border-gray-800 text-center text-sm text-gray-500">
                <p class="mb-2">
                    <strong class="text-gray-400">FDM Filament Recommendation Engine</strong>
                    <span class="mx-2">‚Ä¢</span>
                    Version 1.4.0
                    <span class="mx-2">‚Ä¢</span>
                    November 2025
                </p>
                <p class="text-xs mb-2">
                    Built for the 3D printing community to make material selection more accessible and data-driven.
                    <span class="mx-2">‚Ä¢</span>
                    <a href="https://github.com/minimal3dp/m3dp-filament-recommendation-engine/blob/main/LICENSE" target="_blank" class="hover:text-gray-400 transition-colors">MIT License</a>
                </p>
                <p class="text-xs mb-3">
                    <strong class="text-gray-400">References & Tools:</strong>
                    <a href="https://wiki.polymaker.com/printing-tips/by-material-type" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors">Polymaker Wiki</a>
                    <span class="mx-1 text-gray-700">‚Ä¢</span>
                    <a href="https://us.polymaker.com/pages/filament-guide" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors">Polymaker Guide</a>
                    <span class="mx-1 text-gray-700">‚Ä¢</span>
                    <a href="https://app.polymaker.com/" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400 transition-colors">Polymaker App</a>
                </p>
                <p class="text-xs">
                    <a href="https://minimal3dp.com" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:text-blue-400 transition-colors font-medium">
                        minimal3dp.com
                    </a>
                    <span class="mx-2 text-gray-600">‚Ä¢</span>
                    <span class="text-gray-600">A Minimal3DP Project</span>
                </p>
            </div>
        </footer>
    </div>

    <!-- Material Detail Modal -->
    <div id="material-modal" class="fixed inset-0 z-50 hidden items-center justify-center p-4">
        <div class="modal-backdrop absolute inset-0" onclick="closeMaterialModal()"></div>
        <div class="modal-content relative bg-gray-800 rounded-2xl shadow-2xl max-w-4xl w-full z-10">
            <div class="sticky top-0 bg-gray-800 border-b border-gray-700 p-6 rounded-t-2xl">
                <div class="flex justify-between items-start">
                    <div>
                        <h2 id="modal-title" class="text-3xl font-bold text-white mb-2"></h2>
                        <span id="modal-cluster" class="text-sm font-semibold px-3 py-1 rounded-full"></span>
                    </div>
                    <button onclick="closeMaterialModal()" class="text-gray-400 hover:text-white transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <div id="modal-body" class="p-6 space-y-6">
                <!-- Content will be dynamically populated -->
            </div>
        </div>
    </div>

    <script>
        // Configure GA4 ID (overrideable before this script runs)
        window.GA_MEASUREMENT_ID = window.GA_MEASUREMENT_ID || 'G-5NBZLK7ZND';
        // --- ANALYTICS (GA4) ---
        const GA_MEASUREMENT_ID = window.GA_MEASUREMENT_ID || '';
        window.dataLayer = window.dataLayer || [];
        window.gtag = window.gtag || function(){ dataLayer.push(arguments); };

        function loadGA() {
            try {
                if (!GA_MEASUREMENT_ID) { console.info('[GA4] Measurement ID not set. Set window.GA_MEASUREMENT_ID to enable analytics.'); return; }
                if (document.getElementById('ga4-script')) return;
                const s = document.createElement('script');
                s.id = 'ga4-script';
                s.async = true;
                s.src = `https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`;
                document.head.appendChild(s);
                s.onload = () => {
                    gtag('js', new Date());
                    gtag('config', GA_MEASUREMENT_ID, { send_page_view: true });
                };
            } catch (e) { /* no-op */ }
        }
        // --- DATA ---
        // 4. Embed the CSV data directly into the JavaScript
        // This avoids needing to host the file. For a real app, we'd fetch this.
        const csvData = `Material,Cluster,Strength_XY_MPa,Strength_Z_MPa,Stiffness_Modulus_MPa,Toughness_Impact_kJ_m2,Heat_Resistance_HDT_C,Printability_Score,Cost_Score,UV_Resistant,Hygroscopic,Prone_to_Creep,Requires_Enclosure,Releases_Fumes,Chemical_Resistance_Score,Low_Friction,Annealable_for_HDT,Price_USD_per_kg,Density_g_cm3,Nozzle_Temp_C_Min,Nozzle_Temp_C_Max,Bed_Temp_C_Min,Bed_Temp_C_Max,Requires_Hardened_Nozzle,Strength_XY_MPa_Annealed,Strength_Z_MPa_Annealed,Heat_Resistance_HDT_Annealed_C
HTPLA (Annealable),Standard,60,27,2800,7,58,9,4,false,false,false,false,false,0,false,true,28,1.24,200,230,50,60,false,63,28.35,150
PETG (Standard),Standard,50,22.5,1900,8.1,70,8,4,false,true,true,false,false,4,false,false,23,1.27,230,250,70,85,false,,,
PLA (Standard),Standard,65,29.3,2800,7,56,9,2,false,false,true,false,false,0,false,false,20,1.24,190,215,0,60,false,,,
Nylon (PA12),Engineering,62.5,31.25,2200,40,90,3,7,false,true,true,true,false,2,true,true,60,1.01,240,255,70,90,false,65.6,32.8,100
Nylon (PA6),Engineering,62.5,31.25,2200,40,90,3,6,false,true,true,true,false,2,true,true,60,1.13,240,255,70,90,false,65.6,32.8,100
Nylon PA12,Engineering,55,24.8,1700,40,95,5,7,false,true,false,true,true,5,true,false,60,1.01,250,270,90,110,false,,,
Nylon PA6,Engineering,75,22.5,2500,35,90,4,6,false,true,false,true,true,5,true,false,50,1.14,250,270,90,110,false,,,
PC (Polycarbonate),Engineering,70,31.5,2300,30,113,3,7,true,true,false,true,true,5,false,false,45,1.20,270,300,105,115,false,,,
PC-ABS Blend,Engineering,38.5,17.33,1225,44,123,4,7,false,true,false,true,true,2,false,false,38,1.15,255,270,100,115,false,,,
PET (non-glycol),Engineering,55,24.75,2100,9.5,78,6,4,true,true,false,false,false,1,false,false,30,1.27,240,250,75,90,false,,,
PETG - Carbon Fiber,Engineering,58,26.1,6500,12,82,6,7,false,true,false,false,false,1,false,false,45,1.30,240,255,75,90,true,,,
PLA - Carbon Fiber,Engineering,70,31.5,7000,8,62,7,6,false,false,false,false,false,0,false,false,45,1.30,200,225,50,60,true,,,
Polycarbonate (PC),Engineering,64.5,29.03,2175,35,127.5,2,8,false,true,false,true,false,1,false,false,35,1.20,260,300,110,130,false,,,
Tough PLA / PLA+,Engineering,65,29.3,2102,8.5,52,8,3,false,false,true,false,false,0,false,false,24,1.24,200,225,50,60,false,,,
Nylon PA-CF (Carbon Fiber),Composite,140,28,10000,15,160,5,9,false,true,false,true,true,5,true,false,80,1.15,260,290,90,110,true,,,
PC-CF (Carbon Fiber),Composite,95,28.5,8000,13,125,4,9,true,true,false,true,true,5,false,false,65,1.23,280,310,105,115,true,,,
PETG-CF (Carbon Fiber),Composite,80,24,6500,10,80,7,8,false,true,false,false,false,4,false,false,55,1.35,240,260,70,85,true,,,
ABS,Functional,38,17.1,2100,26.5,91,4,3,false,true,false,true,true,2,false,false,22,1.04,230,250,90,110,false,,,
ASA,Functional,49.5,22.28,1930,41,95,4,5,true,true,false,true,true,2,false,false,28,1.07,240,255,90,110,false,,,
HIPS,Functional,34,15.3,1675,37.5,87.5,5,3,false,false,false,true,true,1,false,false,22,1.04,230,245,90,110,false,,,
HIPS (Soluble Support),Functional,40,18,1900,10,80,6,3,false,true,false,true,true,1,false,false,25,1.07,220,240,95,110,false,,,
PETG,Functional,49,22.05,1913,10.5,75,7,3,false,true,false,false,false,1,false,false,25,1.27,230,245,70,90,false,,,
PLA - Glow-in-the-dark,Functional,32,14.4,2640,27.3,55,7,4,false,false,true,false,false,0,false,false,30,1.26,195,220,50,60,true,,,
PLA - Metal-filled,Functional,34,15.3,2290,4,52,6,8,false,false,true,false,false,0,false,false,60,3.00,195,220,50,60,true,,,
PLA - Silk,Functional,26,11.7,2816,25.5,54,8,3,false,false,true,false,false,0,false,false,25,1.25,190,210,50,60,false,,,
PLA - Wood-filled,Functional,26,11.7,2780,15.7,57,7,4,false,false,true,false,false,0,false,false,30,1.21,190,210,50,60,true,,,
PP (Polypropylene),Functional,35.1,18.7,660,49.1,64,1,5,false,false,false,true,false,3,true,false,40,0.90,230,250,85,105,false,,,
PVA (Soluble Support),Functional,10,4.5,3860,2,60,2,9,false,true,true,false,false,0,false,false,90,1.23,190,210,45,60,false,,,
PVB (IPA-Smoothable),Functional,45,13.5,2500,10,55,8,4,false,true,true,false,false,0,false,false,30,1.24,205,225,60,70,false,,,
TPU 85A (Soft Flexible),Functional,8,3.6,50,6,60,3,5,false,false,false,false,false,2,true,false,32,1.21,215,230,30,50,false,,,
TPU 95A (Flexible),Functional,34.5,15.53,52.5,35,61.5,4,5,false,false,false,false,false,2,true,false,30,1.21,215,235,30,60,false,,,
TPU (Flexible),Flexible,38,17.1,300,60,60,4,6,false,true,false,false,false,3,false,false,40,1.21,215,230,30,50,false,,,
ULTEM 1010,High-Temp,110,33,3300,3.6,215,1,10,true,true,false,true,false,5,false,false,500,1.27,360,390,120,140,false,,,
ULTEM 9085,High-Temp,85,25.5,2150,3.6,165,2,10,true,true,false,true,false,5,false,false,450,1.27,350,380,120,140,false,,,
Nylon - Carbon Fiber (PA12-CF),High-Performance,77.5,41.8,7910,25,140,3,10,false,true,false,true,false,2,true,false,75,1.15,250,270,80,100,true,,,
Nylon - Glass Fiber (PA-GF),High-Performance,72,36,9000,22,135,3,9,false,true,false,true,false,2,false,false,70,1.20,250,270,80,100,true,,,
PEEK,High-Performance,101,50.5,3720,15,217,1,10,true,false,false,true,false,3,true,false,200,1.32,360,400,120,160,false,103,51.5,225
PEKK,High-Performance,105,52.5,3205,12,247,1,10,true,false,false,true,false,3,true,false,180,1.32,355,390,120,150,false,107,53.5,255
PPSU,High-Performance,85,42.5,2800,18,190,1,10,true,false,false,true,false,3,true,false,110,1.29,360,390,120,160,false,87,43.5,195
ULTEM 9085 (PEI),High-Performance,76.2,34.29,2465,10,160,1,10,true,true,false,true,false,3,false,false,120,1.27,350,380,120,160,false,78,35.3,170
`;

        // Additional material data from materials.json
        const materialsDetailData = {
            "PLA (Standard)": {
                "common": {"nozzle_temperature": 210, "bed_temperature": 60, "print_speed": 60, "fan_speed": 100, "retraction_distance_mm": 5.0, "retraction_speed_mm_s": 45, "first_layer_speed_pct": 50},
                "fea": {"Material_Youngs_Modulus_GPa": 3.5, "Material_Tensile_Yield_Strenght_MPa": 50, "Material_Poissons_Ratio": 0.36},
                "thermal": {"thermal_expansion_coefficient": 68, "thermal_conductivity_W_mK": 0.13, "specific_heat_capacity_J_gK": 1.8},
                "creep_resistance": "Low - Not recommended for constant load applications",
                "fatigue": {"cycles_to_failure_at_50pct_UTS": 10000, "fatigue_strength_MPa": 32, "notes": "Prone to creep under sustained load"},
                "properties": {"tensile_strength_MPa": 65.0, "tensile_modulus_MPa": 2850.0, "elongation_at_break_pct": 7.0, "HDT_C": 56.0, "impact_strength_kJ_m2": 6.5}
            },
            "ABS": {
                "common": {"nozzle_temperature": 245, "bed_temperature": 100, "print_speed": 60, "fan_speed": 30, "retraction_distance_mm": 5.0, "retraction_speed_mm_s": 45, "first_layer_speed_pct": 50},
                "fea": {"Material_Youngs_Modulus_GPa": 2.3, "Material_Tensile_Yield_Strenght_MPa": 40, "Material_Poissons_Ratio": 0.35},
                "thermal": {"thermal_expansion_coefficient": 90, "thermal_conductivity_W_mK": 0.17, "specific_heat_capacity_J_gK": 1.5},
                "creep_resistance": "Moderate - Good for general-purpose applications",
                "fatigue": {"cycles_to_failure_at_50pct_UTS": 100000, "fatigue_strength_MPa": 21, "notes": "Better creep resistance than PLA, moderate fatigue performance"},
                "properties": {"tensile_strength_MPa": 43.0, "tensile_modulus_MPa": 2300.0, "elongation_at_break_pct": 3.0, "HDT_C": 98.0, "impact_strength_kJ_m2": 20.0}
            },
            "PETG (Standard)": {
                "common": {"nozzle_temperature": 245, "bed_temperature": 80, "print_speed": 50, "fan_speed": 50, "retraction_distance_mm": 4.5, "retraction_speed_mm_s": 40, "first_layer_speed_pct": 50},
                "fea": {"Material_Youngs_Modulus_GPa": 2.1, "Material_Tensile_Yield_Strenght_MPa": 50, "Material_Poissons_Ratio": 0.38},
                "thermal": {"thermal_expansion_coefficient": 60, "thermal_conductivity_W_mK": 0.29, "specific_heat_capacity_J_gK": 1.0},
                "creep_resistance": "Good - Suitable for moderate load applications",
                "fatigue": {"cycles_to_failure_at_50pct_UTS": 500000, "fatigue_strength_MPa": 26, "notes": "Excellent creep resistance, good for functional parts"},
                "properties": {"tensile_strength_MPa": 53.0, "tensile_modulus_MPa": 2080.0, "elongation_at_break_pct": 6.0, "HDT_C": 70.0, "impact_strength_kJ_m2": 7.2}
            },
            "Nylon (PA6)": {
                "common": {"nozzle_temperature": 255, "bed_temperature": 85, "print_speed": 40, "fan_speed": 20, "retraction_distance_mm": 6.0, "retraction_speed_mm_s": 40, "first_layer_speed_pct": 50},
                "fea": {"Material_Youngs_Modulus_GPa": 1.6, "Material_Tensile_Yield_Strenght_MPa": 46, "Material_Poissons_Ratio": 0.39},
                "thermal": {"thermal_expansion_coefficient": 80, "thermal_conductivity_W_mK": 0.25, "specific_heat_capacity_J_gK": 1.7},
                "creep_resistance": "Excellent - Ideal for constant load applications",
                "fatigue": {"cycles_to_failure_at_50pct_UTS": 1000000, "fatigue_strength_MPa": 37, "notes": "Outstanding creep and fatigue resistance, hygroscopic"},
                "properties": {"tensile_strength_MPa": 62.5, "tensile_modulus_MPa": 2200.0, "elongation_at_break_pct": 50.0, "HDT_C": 90.0, "impact_strength_kJ_m2": 40.0}
            },
            "Nylon (PA12)": {
                "common": {"nozzle_temperature": 255, "bed_temperature": 85, "print_speed": 40, "fan_speed": 20, "retraction_distance_mm": 6.0, "retraction_speed_mm_s": 40, "first_layer_speed_pct": 50},
                "fea": {"Material_Youngs_Modulus_GPa": 1.6, "Material_Tensile_Yield_Strenght_MPa": 46, "Material_Poissons_Ratio": 0.39},
                "thermal": {"thermal_expansion_coefficient": 80, "thermal_conductivity_W_mK": 0.25, "specific_heat_capacity_J_gK": 1.7},
                "creep_resistance": "Excellent - Ideal for constant load applications",
                "fatigue": {"cycles_to_failure_at_50pct_UTS": 1000000, "fatigue_strength_MPa": 37, "notes": "Outstanding creep and fatigue resistance, hygroscopic"},
                "properties": {"tensile_strength_MPa": 62.5, "tensile_modulus_MPa": 2200.0, "elongation_at_break_pct": 50.0, "HDT_C": 90.0, "impact_strength_kJ_m2": 40.0}
            },
            "PC (Polycarbonate)": {
                "common": {"nozzle_temperature": 280, "bed_temperature": 110, "print_speed": 30, "fan_speed": 0},
                "fea": {"Material_Youngs_Modulus_GPa": 2.4, "Material_Tensile_Yield_Strenght_MPa": 65, "Material_Poissons_Ratio": 0.38}
            },
            "TPU (Flexible)": {
                "common": {"nozzle_temperature": 225, "bed_temperature": 60, "print_speed": 25, "fan_speed": 80, "retraction_distance_mm": 2.0, "retraction_speed_mm_s": 25, "first_layer_speed_pct": 50},
                "fea": {"Material_Youngs_Modulus_GPa": 0.026, "Material_Tensile_Yield_Strenght_MPa": 6.9, "Material_Poissons_Ratio": 0.5},
                "thermal": {"thermal_expansion_coefficient": 150, "thermal_conductivity_W_mK": 0.16, "specific_heat_capacity_J_gK": 1.8},
                "creep_resistance": "Excellent - Elastomeric behavior, recovers from deformation",
                "fatigue": {"cycles_to_failure_at_50pct_UTS": 5000000, "fatigue_strength_MPa": 13, "notes": "Exceptional fatigue resistance due to elastomeric nature"},
                "properties": {"tensile_strength_MPa": 26.0, "tensile_modulus_MPa": 26.0, "elongation_at_break_pct": 450.0, "HDT_C": 55.0, "impact_strength_kJ_m2": 60.0}
            },
            "ASA": {
                "common": {"nozzle_temperature": 250, "bed_temperature": 100, "print_speed": 55, "fan_speed": 30, "retraction_distance_mm": 5.0, "retraction_speed_mm_s": 45, "first_layer_speed_pct": 50},
                "fea": {"Material_Youngs_Modulus_GPa": 2.15, "Material_Tensile_Yield_Strenght_MPa": 42, "Material_Poissons_Ratio": 0.35},
                "thermal": {"thermal_expansion_coefficient": 85, "thermal_conductivity_W_mK": 0.18, "specific_heat_capacity_J_gK": 1.5},
                "creep_resistance": "Good - UV and weather resistant, better than ABS",
                "fatigue": {"cycles_to_failure_at_50pct_UTS": 150000, "fatigue_strength_MPa": 24, "notes": "Excellent outdoor durability, good creep resistance"},
                "properties": {"tensile_strength_MPa": 49.5, "tensile_modulus_MPa": 2150.0, "elongation_at_break_pct": 17.5, "HDT_C": 95.0, "impact_strength_kJ_m2": 41.0}
            },
            "ULTEM 9085": {
                "properties": {"tensile_strength_MPa": 66.0, "tensile_modulus_MPa": 2465.0, "elongation_at_break_pct": 3.65, "HDT_C": 165.0, "Tg_C": 177.0}
            },
            "PEKK": {
                "properties": {"tensile_strength_MPa": 105.0, "tensile_modulus_MPa": 3205.0, "elongation_at_break_pct": 9.5, "HDT_C": 247.0, "Tg_C": 162.0}
            },
            "PEEK": {
                "common": {"nozzle_temperature": 400, "bed_temperature": 140, "print_speed": 30, "fan_speed": 0, "retraction_distance_mm": 3.0, "retraction_speed_mm_s": 30, "first_layer_speed_pct": 50},
                "fea": {"Material_Youngs_Modulus_GPa": 3.72, "Material_Tensile_Yield_Strenght_MPa": 92, "Material_Poissons_Ratio": 0.38},
                "thermal": {"thermal_expansion_coefficient": 47, "thermal_conductivity_W_mK": 0.25, "specific_heat_capacity_J_gK": 1.3},
                "creep_resistance": "Excellent - Superior high-temperature performance",
                "fatigue": {"cycles_to_failure_at_50pct_UTS": 2000000, "fatigue_strength_MPa": 50, "notes": "Exceptional creep resistance, biocompatible, aerospace-grade"},
                "properties": {"tensile_strength_MPa": 101.0, "tensile_modulus_MPa": 3720.0, "elongation_at_break_pct": 27.0, "HDT_C": 216.5, "Tg_C": 143.0}
            }
        };

        // Optional per-material annealing presets (time/temp/notes + references)
        const annealingPresets = {
            "HTPLA (Annealable)": {
                temp: "100¬∞C",
                time: "30‚Äì60 min",
                notes: "Bake on a flat surface or bury in sand/salt for support. Expect measurable shrink‚Äîprint test coupons to calibrate.",
                references: [
                    { label: "MatterHackers: Heat Treating Tough PLA 3D Printed Parts", url: "https://www.matterhackers.com/articles/how-to-anneal-tough-pla-and-htpla?srsltid=AfmBOory6F28xl93QBKbpweBxuNkw16QrWAR9ad49o6fpF3NniwceDjW" },
                    { label: "CNC Kitchen: Annealing PLA Strength Test", url: "https://www.cnckitchen.com/blog/better-performing-3d-prints-with-annealing-but-part-1-pla" }
                ]
            },
            "PLA (Standard)": {
                temp: "60‚Äì70¬∞C",
                time: "20‚Äì30 min",
                notes: "Standard PLA can benefit from low-temperature annealing to reduce internal stresses. Use a heated bed or oven. Avoid exceeding 70¬∞C to prevent warping.",
                references: [
                    { label: "Polymaker Wiki: PLA Printing Tips", url: "https://wiki.polymaker.com/printing-tips/by-material-type" },
                    { label: "CNC Kitchen: PLA Annealing Guide", url: "https://www.cnckitchen.com/blog/better-performing-3d-prints-with-annealing-but-part-1-pla" }
                ]
            },
            "PETG (Standard)": {
                temp: "80‚Äì90¬∞C",
                time: "30‚Äì45 min",
                notes: "PETG can be annealed to improve heat resistance and reduce layer visibility. Keep parts constrained to minimize warping. Gradual cooling recommended.",
                references: [
                    { label: "Polymaker Wiki: PETG Printing Tips", url: "https://wiki.polymaker.com/printing-tips/by-material-type" },
                    { label: "MatterHackers: PETG Post-Processing", url: "https://www.matterhackers.com/articles/3d-printer-filament-comparison-guide" }
                ]
            },
            "Nylon (PA6)": {
                temp: "80‚Äì100¬∞C",
                time: "45‚Äì90 min",
                notes: "Nylon benefits significantly from annealing to improve crystallinity and strength. Use constrained geometry (sand/salt bed) to control dimensional change. Expect 1-2% shrinkage.",
                references: [
                    { label: "Polymaker Wiki: Nylon Printing Tips", url: "https://wiki.polymaker.com/printing-tips/by-material-type" },
                    { label: "Prusa: Nylon Post-Processing", url: "https://help.prusa3d.com/materials" }
                ]
            },
            "Polycarbonate (PC)": {
                temp: "110‚Äì130¬∞C",
                time: "60‚Äì120 min",
                notes: "PC requires higher annealing temperatures. Use an oven with precise temperature control. Constrain parts to prevent warping. Can significantly improve impact strength and heat resistance.",
                references: [
                    { label: "Polymaker Wiki: PC Printing Tips", url: "https://wiki.polymaker.com/printing-tips/by-material-type" },
                    { label: "MatterHackers: Polycarbonate Guide", url: "https://www.matterhackers.com/articles/polycarbonate-the-king-of-3d-printing-materials" }
                ]
            }
            // Add more exact-name presets as TDS-backed data becomes available
        };

        // Nozzle compatibility data
        const nozzleInfo = {
            "brass": {
                name: "Brass (Standard)",
                description: "Standard nozzle suitable for non-abrasive materials like PLA, PETG, ABS, TPU. Not recommended for materials containing fibers or particles.",
                compatible: (material) => !material.Requires_Hardened_Nozzle
            },
            "hardened-steel": {
                name: "Hardened Steel",
                description: "Durable nozzle suitable for all materials including abrasive filaments with carbon fiber, glass fiber, wood, or metal particles.",
                compatible: (material) => true
            },
            "ruby": {
                name: "Ruby Tipped",
                description: "Premium nozzle with exceptional wear resistance. Ideal for long-term printing with abrasive materials.",
                compatible: (material) => true
            },
            "stainless-steel": {
                name: "Stainless Steel",
                description: "Food-safe nozzle option. Suitable for non-abrasive materials. Required when printing food-contact items.",
                compatible: (material) => !material.Requires_Hardened_Nozzle
            },
            "all": {
                name: "All Nozzles",
                description: "Showing all materials regardless of nozzle compatibility",
                compatible: (material) => true
            }
        };

        // --- AFFILIATE CONFIG & HELPERS ---
        const affiliateConfig = {
            enabled: true,
            amazonTag: 'mwf064-20',
            baseSearchUrl: 'https://www.amazon.com/s?k=',
            ref: 'assoc_m3dp'
        };

        function makeAmazonSearchUrl(query) {
            const q = encodeURIComponent(query);
            const tag = affiliateConfig.amazonTag ? `&tag=${affiliateConfig.amazonTag}` : '';
            const ref = affiliateConfig.ref ? `&ref=${affiliateConfig.ref}` : '';
            return `${affiliateConfig.baseSearchUrl}${q}${tag}${ref}`;
        }

        function trackAffiliateClick(materialName, itemLabel) {
            try {
                if (window.gtag) {
                    window.gtag('event', 'affiliate_click', {
                        event_category: 'monetization',
                        event_label: itemLabel,
                        material: materialName,
                        partner: 'amazon'
                    });
                }
            } catch (_) { /* no-op */ }
        }

        function buildAffiliateSuggestions(material) {
            const items = [];
            // Always offer a direct filament search for this material
            items.push({
                label: `Buy ${material.Material} filament`,
                query: `${material.Material} filament 1.75mm`
            });

            // Hygroscopic materials benefit from a filament dryer
            if (material.Hygroscopic === true) {
                items.push({ label: 'Filament dryer', query: 'filament dryer' });
            }

            // Abrasive materials benefit from hardened nozzles
            if (material.Requires_Hardened_Nozzle === true) {
                items.push({ label: 'Hardened steel nozzles (0.4mm)', query: 'hardened steel nozzle 0.4mm 1.75mm' });
            }

            // Fumes or enclosure-required ‚Üí enclosure search
            if (material.Requires_Enclosure === true || material.Releases_Fumes === true) {
                items.push({ label: '3D printer enclosure', query: '3D printer enclosure' });
            }

            // Flexible materials (e.g., TPU) often benefit from direct drive
            if (String(material.Cluster).toLowerCase().includes('flexible')) {
                items.push({ label: 'Direct-drive extruder for TPU', query: 'direct drive extruder 3D printer TPU' });
            }

            // Keep UI compact: limit to 4 suggestions
            return items.slice(0, 4);
        }

        function renderAffiliateSection(material) {
            if (!affiliateConfig.enabled) return '';
            const suggestions = buildAffiliateSuggestions(material);
            if (!suggestions.length) return '';

            const buttonsHtml = suggestions.map((s, idx) => {
                const url = makeAmazonSearchUrl(s.query);
                // Make the first suggestion (Buy filament) a bold blue button, others as subtle gray
                const isBuy = idx === 0;
                const btnClass = isBuy
                    ? 'inline-flex items-center justify-center px-4 py-2 rounded-lg text-sm font-semibold bg-blue-600 hover:bg-blue-500 text-white shadow-md transition-colors border border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2'
                    : 'inline-flex items-center justify-center px-3 py-2 rounded-lg text-sm font-medium bg-gray-700 hover:bg-gray-600 text-gray-100 transition-colors';
                return `
                    <a href="${url}" target="_blank" rel="nofollow sponsored noopener" onclick="trackAffiliateClick('${material.Material.replace(/'/g, "\\'")}', '${s.label.replace(/'/g, "\\'")}')"
                       class="${btnClass}">
                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                        ${s.label}
                    </a>`;
            }).join('');

            return `
                <div class="bg-gray-700 rounded-lg p-5">
                    <h3 class="text-xl font-bold text-white mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        Recommended Gear (Affiliate)
                    </h3>
                    <p class="text-xs text-gray-400 mb-3">As an Amazon Associate, minimal3dp.com earns from qualifying purchases. These links help support this tool at no cost to you.</p>
                    <div class="flex flex-wrap gap-2">
                        ${buttonsHtml}
                    </div>
                </div>
            `;
        }

        function trackCtaClick(target, materialName) {
            try {
                if (window.gtag) {
                    window.gtag('event', 'cta_click', {
                        event_category: 'engagement',
                        event_label: target,
                        material: materialName
                    });
                }
            } catch (_) { /* no-op */ }
        }

        // --- GLOBAL STATE ---
        let allMaterials = [];
        let viewMode = 'detailed'; // 'detailed' | 'compact'
        let selectedForCompare = []; // array of material names
        const filters = {
            checkboxes: [],
            sliders: []
        };

        // --- DOM ELEMENTS ---
        const resultsContainer = document.getElementById('results-container');
        const noResultsEl = document.getElementById('no-results');
        const resultsCountEl = document.getElementById('results-count');
        const checkboxContainer = document.getElementById('filter-checkboxes');
        const sliderContainer = document.getElementById('filter-sliders');

        // --- UTILITY FUNCTIONS ---

        /**
         * Parses a raw CSV string into an array of objects.
         * Automatically handles headers and coerces types (string, bool, number).
         */
        function parseCSV(data) {
            const lines = data.trim().split('\n');
            const headers = lines.shift().split(',').map(h => h.trim());

            return lines.map(line => {
                const values = line.split(',');
                const obj = {};
                headers.forEach((header, index) => {
                    const val = values[index] ? values[index].trim() : '';
                    obj[header] = coerceType(val);
                });
                return obj;
            });
        }

        /**
         * Coerces a string value to its likely type (boolean, number, or string).
         */
        function coerceType(val) {
            if (val.toLowerCase() === 'true') return true;
            if (val.toLowerCase() === 'false') return false;
            const num = parseFloat(val);
            if (!isNaN(num) && isFinite(val) && val.match(/^[\d.eE+-]+$/)) return num;
            return val;
        }

        // --- RENDER FUNCTIONS ---

        function setViewMode(mode) {
            viewMode = mode === 'compact' ? 'compact' : 'detailed';
            try { localStorage.setItem('m3dp_viewMode', viewMode); } catch (_) { /* no-op */ }
            updateViewToggleUI();
            filterAndRender();
        }

        function updateViewToggleUI() {
            const btnDetailed = document.getElementById('view-detailed-btn');
            const btnCompact = document.getElementById('view-compact-btn');
            if (!btnDetailed || !btnCompact) return;
            if (viewMode === 'detailed') {
                btnDetailed.className = 'px-3 py-1.5 text-xs rounded-l-lg bg-blue-600 text-white border border-blue-500 hover:bg-blue-500 transition-colors';
                btnCompact.className = 'px-3 py-1.5 text-xs rounded-r-lg bg-gray-700 text-gray-100 border border-gray-600 hover:bg-gray-600 transition-colors';
            } else {
                btnDetailed.className = 'px-3 py-1.5 text-xs rounded-l-lg bg-gray-700 text-gray-100 border border-gray-600 hover:bg-gray-600 transition-colors';
                btnCompact.className = 'px-3 py-1.5 text-xs rounded-r-lg bg-blue-600 text-white border border-blue-500 hover:bg-blue-500 transition-colors';
            }
        }

        /**
         * Renders an array of material objects into the results container.
         */
        // Helper: return annealed-aware values for select props
        function getAnnealedAware(material, key) {
            if (!window.__annealedMode) return material[key];
            if (!material.Annealable_for_HDT) return material[key];
            const map = {
                'Strength_XY_MPa': 'Strength_XY_MPa_Annealed',
                'Heat_Resistance_HDT_C': 'Heat_Resistance_HDT_Annealed_C'
            };
            const k = map[key];
            if (k && material[k] !== undefined && material[k] !== null && material[k] !== '') return material[k];
            return material[key];
        }

        function renderResults(materials) {
            // Clear previous results
            resultsContainer.innerHTML = '';

            // Update count
            resultsCountEl.textContent = `${materials.length} found`;

            // Show/hide 'no results' message
            if (materials.length === 0) {
                noResultsEl.classList.remove('hidden');
            } else {
                noResultsEl.classList.add('hidden');
            }

            // Create and append a card for each material
            materials.forEach(material => {
                const card = document.createElement('div');
                const baseClass = viewMode === 'compact'
                    ? 'relative bg-gray-800 rounded-lg shadow p-4 transform transition-all hover:scale-[1.01]'
                    : 'relative bg-gray-800 rounded-lg shadow-xl p-5 transform transition-all hover:scale-[1.02]';
                card.className = baseClass;

                // Determine cluster color
                let clusterColor = 'bg-gray-600';
                if (material.Cluster === 'Engineering') clusterColor = 'bg-blue-600';
                if (material.Cluster === 'Standard') clusterColor = 'bg-green-600';
                if (material.Cluster === 'Composite') clusterColor = 'bg-indigo-600';
                if (material.Cluster === 'Functional') clusterColor = 'bg-yellow-600';
                if (material.Cluster === 'High-Temp') clusterColor = 'bg-red-600';
                if (material.Cluster === 'Flexible') clusterColor = 'bg-pink-600';

                // Compare checkbox control (top-right)
                const isChecked = selectedForCompare.includes(material.Material);
                const compareToggleHtml = `
                    <label class="absolute top-3 md:top-2 right-2 inline-flex items-center gap-0.5 sm:gap-1 text-[10px] sm:text-[11px] text-gray-200 bg-gray-700/70 hover:bg-gray-700 px-1.5 sm:px-2 pt-1 pb-3 rounded border border-gray-600 cursor-pointer select-none"
                           onclick="event.stopPropagation()">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} class="accent-blue-500" data-compare="${material.Material.replace(/"/g, '&quot;')}">
                        <span>Compare</span>
                    </label>`;

                // Precompute displayed values (annealed-aware)
                const dispStrengthXY = getAnnealedAware(material, 'Strength_XY_MPa');
                const dispHDT = getAnnealedAware(material, 'Heat_Resistance_HDT_C');

                if (viewMode === 'compact') {
                    card.innerHTML = `
                        ${compareToggleHtml}
                        <div class="flex justify-between items-start mb-2 pt-8">
                            <h3 class="text-lg font-semibold text-white">${material.Material}</h3>
                            <span class="text-[10px] leading-tight font-semibold ${clusterColor} text-white px-2 py-0.5 rounded-full">${material.Cluster}</span>
                        </div>
                        <div class="flex flex-wrap gap-1 text-[11px] text-gray-200">
                            <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-700">P: ${material.Printability_Score}/10</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-700">XY: ${dispStrengthXY} MPa</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-700">HDT: ${dispHDT}¬∞C</span>
                            <span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-700">Cost: ${material.Cost_Score}/10</span>
                            ${material.Annealable_for_HDT ? '<span class="inline-flex items-center px-2 py-0.5 rounded bg-amber-800 text-amber-100">Annealable</span>' : ''}
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        ${compareToggleHtml}
                        <div class="flex justify-between items-start mb-3 pt-8">
                            <h3 class="text-2xl font-bold text-white">${material.Material}</h3>
                            <span class="text-xs leading-tight font-semibold ${clusterColor} text-white px-2.5 py-1 rounded-full">${material.Cluster}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-300">
                            <!-- Key Properties -->
                            <div><strong>Printability:</strong> <span class="font-light">${material.Printability_Score}/10</span></div>
                            <div><strong>Cost Score:</strong> <span class="font-light">${material.Cost_Score}/10</span></div>
                            <div><strong>Strength (XY):</strong> <span class="font-light">${dispStrengthXY} MPa</span></div>
                            <div><strong>Heat Resist (HDT):</strong> <span class="font-light">${dispHDT} ¬∞C</span></div>
                            <div><strong>Toughness:</strong> <span class="font-light">${material.Toughness_Impact_kJ_m2} kJ/m¬≤</span></div>
                            <div><strong>Stiffness:</strong> <span class="font-light">${material.Stiffness_Modulus_MPa} MPa</span></div>
                        </div>
                        
                        <div class="border-t border-gray-700 mt-4 pt-3 text-xs text-gray-400 flex flex-wrap gap-2">
                            <!-- Badges for key boolean attributes -->
                            ${material.UV_Resistant ? '<span class="inline-block bg-yellow-800 text-yellow-100 px-2 py-0.5 rounded">UV Resistant</span>' : ''}
                            ${!material.Hygroscopic ? '<span class="inline-block bg-blue-800 text-blue-100 px-2 py-0.5 rounded">Low Moisture</span>' : ''}
                            ${!material.Requires_Enclosure ? '<span class="inline-block bg-green-800 text-green-100 px-2 py-0.5 rounded">No Enclosure</span>' : ''}
                            ${material.Requires_Hardened_Nozzle ? '<span class="inline-block bg-red-800 text-red-100 px-2 py-0.5 rounded">Abrasive</span>' : ''}
                            ${material.Annealable_for_HDT ? '<span class="inline-block bg-amber-800 text-amber-100 px-2 py-0.5 rounded">Annealable</span>' : ''}
                            ${window.__annealedMode && material.Annealable_for_HDT ? '<span class="inline-block bg-amber-700 text-white px-2 py-0.5 rounded">Annealed Mode</span>' : ''}
                        </div>
                        <button class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors">
                            View Details
                        </button>
                    `;
                }
                
                // Add click handler for the card
                card.style.cursor = 'pointer';
                card.addEventListener('click', () => openMaterialModal(material));

                // Wire up compare checkbox inside the card
                const compareInput = card.querySelector('input[type="checkbox"][data-compare]');
                if (compareInput) {
                    compareInput.addEventListener('change', (e) => {
                        e.stopPropagation();
                        const name = compareInput.getAttribute('data-compare');
                        toggleCompareSelection(name, e.target.checked);
                    });
                }
                
                resultsContainer.appendChild(card);
            });
        }

        // --- MODAL FUNCTIONS ---

        /**
         * Opens the material detail modal with comprehensive information
         */
        function openMaterialModal(material) {
            const modal = document.getElementById('material-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalCluster = document.getElementById('modal-cluster');
            const modalBody = document.getElementById('modal-body');

            // Set title and cluster
            modalTitle.textContent = material.Material;
            modalCluster.textContent = material.Cluster;
            
            // Set cluster color
            let clusterColor = 'bg-gray-600';
            if (material.Cluster === 'Engineering') clusterColor = 'bg-blue-600';
            if (material.Cluster === 'Standard') clusterColor = 'bg-green-600';
            if (material.Cluster === 'Composite') clusterColor = 'bg-indigo-600';
            if (material.Cluster === 'Functional') clusterColor = 'bg-yellow-600';
            if (material.Cluster === 'High-Temp') clusterColor = 'bg-red-600';
            if (material.Cluster === 'Flexible') clusterColor = 'bg-pink-600';
            modalCluster.className = `text-sm font-semibold px-3 py-1 rounded-full ${clusterColor} text-white`;

            // Get additional data if available
            const additionalData = materialsDetailData[material.Material] || {};

            // Build modal content
            let modalContent = '';

            // Print Settings Section
            if (additionalData.common) {
                modalContent += `
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            Recommended Print Settings
                        </h3>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                            <div><strong>Nozzle Temp:</strong> ${additionalData.common.nozzle_temperature || material.Nozzle_Temp_C_Min + '-' + material.Nozzle_Temp_C_Max}¬∞C</div>
                            <div><strong>Bed Temp:</strong> ${additionalData.common.bed_temperature || material.Bed_Temp_C_Min + '-' + material.Bed_Temp_C_Max}¬∞C</div>
                            <div><strong>Print Speed:</strong> ${additionalData.common.print_speed || 'Varies'} mm/s</div>
                            <div><strong>Fan Speed:</strong> ${additionalData.common.fan_speed !== null && additionalData.common.fan_speed !== undefined ? additionalData.common.fan_speed + '%' : 'Varies'}</div>
                        </div>
                    </div>
                `;
            } else {
                // Fallback to CSV data
                modalContent += `
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="text-xl font-bold text-white mb-4">Temperature Ranges</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                            <div><strong>Nozzle Temp:</strong> ${material.Nozzle_Temp_C_Min}-${material.Nozzle_Temp_C_Max}¬∞C</div>
                            <div><strong>Bed Temp:</strong> ${material.Bed_Temp_C_Min}-${material.Bed_Temp_C_Max}¬∞C</div>
                        </div>
                    </div>
                `;
            }

            // Mechanical Properties Section
            modalContent += `
                <div class="bg-gray-700 rounded-lg p-5">
                    <h3 class="text-xl font-bold text-white mb-4">Mechanical Properties</h3>
                    <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                        <div><strong>Strength (XY):</strong> ${material.Strength_XY_MPa} MPa</div>
                        <div><strong>Strength (Z):</strong> ${material.Strength_Z_MPa} MPa</div>
                        <div><strong>Stiffness (Modulus):</strong> ${material.Stiffness_Modulus_MPa} MPa</div>
                        <div><strong>Toughness (Impact):</strong> ${material.Toughness_Impact_kJ_m2} kJ/m¬≤</div>
                        <div><strong>Heat Resistance (HDT):</strong> ${material.Heat_Resistance_HDT_C}¬∞C</div>
                        <div><strong>Density:</strong> ${material.Density_g_cm3} g/cm¬≥</div>
                        ${material.Annealable_for_HDT ? `
                            <div class="col-span-2 mt-2 p-3 bg-yellow-900/30 border border-yellow-700 rounded">
                                <strong class="text-yellow-300">Annealable:</strong>
                                <div class="mt-1">After annealing: Strength ${material.Strength_XY_MPa_Annealed} MPa, HDT ${material.Heat_Resistance_HDT_Annealed_C}¬∞C</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;

            // FEA Properties (if available)
            if (additionalData.fea) {
                modalContent += `
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="text-xl font-bold text-white mb-4">FEA Properties</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                            <div><strong>Young's Modulus:</strong> ${additionalData.fea.Material_Youngs_Modulus_GPa} GPa</div>
                            <div><strong>Tensile Yield Strength:</strong> ${additionalData.fea.Material_Tensile_Yield_Strenght_MPa} MPa</div>
                            <div><strong>Poisson's Ratio:</strong> ${additionalData.fea.Material_Poissons_Ratio}</div>
                        </div>
                    </div>
                `;
            }

            // Thermal Properties (if available)
            if (additionalData.thermal) {
                modalContent += `
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Thermal Properties
                        </h3>
                        <div class="grid grid-cols-2 gap-4 text-sm text-gray-300">
                            <div title="Coefficient of thermal expansion - how much the material expands per degree Celsius"><strong>Thermal Expansion:</strong> ${additionalData.thermal.thermal_expansion_coefficient} √ó 10‚Åª‚Å∂ /¬∞C</div>
                            <div><strong>Thermal Conductivity:</strong> ${additionalData.thermal.thermal_conductivity_W_mK} W/(m¬∑K)</div>
                            <div class="col-span-2"><strong>Specific Heat Capacity:</strong> ${additionalData.thermal.specific_heat_capacity_J_gK} J/(g¬∑K)</div>
                        </div>
                    </div>
                `;
            }

            // Long-term Performance (if available)
            if (additionalData.creep_resistance || additionalData.fatigue) {
                modalContent += `
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Long-term Performance
                        </h3>
                        <div class="space-y-3 text-sm text-gray-300">
                            ${additionalData.creep_resistance ? `
                                <div class="p-3 bg-gray-800 rounded">
                                    <strong class="text-white">Creep Resistance:</strong>
                                    <div class="mt-1">${additionalData.creep_resistance}</div>
                                </div>
                            ` : ''}
                            ${additionalData.fatigue ? `
                                <div class="p-3 bg-gray-800 rounded">
                                    <strong class="text-white">Fatigue Performance:</strong>
                                    <div class="mt-2 grid grid-cols-2 gap-2">
                                        <div><strong>Cycles to Failure:</strong> ${additionalData.fatigue.cycles_to_failure_at_50pct_UTS.toLocaleString()}</div>
                                        <div><strong>Fatigue Strength:</strong> ${additionalData.fatigue.fatigue_strength_MPa} MPa</div>
                                    </div>
                                    ${additionalData.fatigue.notes ? `<div class="mt-2 text-gray-400 italic">${additionalData.fatigue.notes}</div>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Annealing Guide (if annealable or has annealed fields)
            const isAnnealable = !!material.Annealable_for_HDT || (material.Strength_XY_MPa_Annealed || material.Heat_Resistance_HDT_Annealed_C);
            if (isAnnealable) {
                // Prefer explicit preset when available; else infer by material family
                const preset = annealingPresets[material.Material];
                const nameLower = String(material.Material || '').toLowerCase();
                let guide = preset ? { temp: preset.temp, time: preset.time, notes: preset.notes } : { temp: '70‚Äì110¬∞C', time: '30‚Äì120 min', notes: 'Start low; verify with test coupons' };
                if (!preset) {
                    if (nameLower.includes('pla')) guide = { temp: '80‚Äì110¬∞C', time: '30‚Äì60 min', notes: 'HTPLA prefers ~100¬∞C; standard PLA ~80‚Äì90¬∞C' };
                    else if (nameLower.includes('petg') || nameLower.includes('pet ')) guide = { temp: '70‚Äì80¬∞C', time: '45‚Äì90 min', notes: 'Avoid overheating to prevent sagging' };
                    else if (nameLower.includes('nylon') || nameLower.includes(' pa6') || nameLower.includes(' pa12') || nameLower.includes(' pa11')) guide = { temp: '70‚Äì90¬∞C', time: '2‚Äì6 hours', notes: 'Dry thoroughly; slow cool to limit warp' };
                    else if (nameLower.includes('pc')) guide = { temp: '110‚Äì130¬∞C', time: '60‚Äì120 min', notes: 'Use enclosure/oven with tight control' };
                    else if (nameLower.includes('peek')) guide = { temp: '200‚Äì230¬∞C', time: '60‚Äì120 min', notes: 'Requires high-temp oven; specialist materials' };
                    else if (nameLower.includes('pekk')) guide = { temp: '220‚Äì255¬∞C', time: '60‚Äì120 min', notes: 'Requires high-temp oven; specialist materials' };
                }

                modalContent += `
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="text-xl font-bold text-white mb-3 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Annealing Guide
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm text-gray-300">
                            <div><strong>Suggested Temperature:</strong> ${guide.temp}</div>
                            <div><strong>Typical Soak Time:</strong> ${guide.time}</div>
                            <div><strong>Notes:</strong> ${guide.notes}</div>
                        </div>
                        <div class="mt-4 text-sm text-gray-300">
                            <ol class="list-decimal ml-5 space-y-1">
                                <li>Dry the part (if hygroscopic) before annealing.</li>
                                <li>Place on a flat, heat-safe surface; optionally bury in fine sand or salt to support geometry.</li>
                                <li>Preheat oven; ramp slowly to target temperature.</li>
                                <li>Soak for the recommended time; avoid drafts or rapid temperature swings.</li>
                                <li>Cool down slowly inside the oven to room temperature to minimize warping.</li>
                            </ol>
                        </div>
                        <div class="mt-4 p-4 bg-yellow-900/50 border border-yellow-700 rounded">
                            <div class="text-yellow-200 font-semibold mb-1">Warnings: Dimensional Change & Warping Risk</div>
                            <ul class="text-yellow-100 text-sm list-disc ml-5 space-y-1">
                                <li>Expect 1‚Äì5% dimensional change (shrink/expansion varies by polymer and infill).</li>
                                <li>Critical dimensions may shift; print and anneal test coupons to calibrate scale.</li>
                                <li>Thin features and overhangs can deform; use support media (sand/salt) when needed.</li>
                                <li>Anneal on a flat, rigid surface to reduce curl; slow cool to limit internal stresses.</li>
                            </ul>
                        </div>
                        <div class="mt-3 text-xs text-gray-400">
                            <span class="block mb-1 font-semibold text-gray-300">References</span>
                            ${(() => {
                                const refs = (annealingPresets[material.Material]?.references) || [
                                    { label: 'MatterHackers: Heat Treating 3D Printed Parts', url: 'https://www.matterhackers.com/articles/how-to-anneal-tough-pla-and-htpla?srsltid=AfmBOoocLN5tqiAjHr6lZxnOqTqxKAd9nOuOtSNHUcz4oZjPOucYegMG' },
                                    { label: 'CNC Kitchen: Annealing PLA Strength Test', url: 'https://www.cnckitchen.com/blog/better-performing-3d-prints-with-annealing-but-part-1-pla' },
                                    { label: 'Prusa Blog: Heat-Treating (Annealing) 3D Prints', url: 'https://blog.prusa3d.com/how-to-improve-your-3d-prints-with-annealing_31088/' }
                                ];
                                return refs.map((r, idx) => `${idx>0 ? '<span class=\"mx-2\">‚Ä¢</span>' : ''}<a class=\"underline hover:text-blue-300\" target=\"_blank\" rel=\"noopener noreferrer\" href=\"${r.url}\">${r.label}</a>`).join('');
                            })()}
                        </div>
                    </div>
                `;
            }

            // Material Characteristics
            modalContent += `
                <div class="bg-gray-700 rounded-lg p-5">
                    <h3 class="text-xl font-bold text-white mb-4">Material Characteristics</h3>
                    <div class="grid grid-cols-2 gap-3 text-sm">
                        <div class="flex items-center ${material.UV_Resistant ? 'text-green-400' : 'text-red-400'}">
                            <span class="mr-2">${material.UV_Resistant ? '‚úì' : '‚úó'}</span> UV Resistant
                        </div>
                        <div class="flex items-center ${!material.Hygroscopic ? 'text-green-400' : 'text-yellow-400'}">
                            <span class="mr-2">${!material.Hygroscopic ? '‚úì' : '‚ö†'}</span> ${material.Hygroscopic ? 'Hygroscopic (needs drying)' : 'Low Moisture Absorption'}
                        </div>
                        <div class="flex items-center ${!material.Prone_to_Creep ? 'text-green-400' : 'text-yellow-400'}">
                            <span class="mr-2">${!material.Prone_to_Creep ? '‚úì' : '‚ö†'}</span> ${material.Prone_to_Creep ? 'Prone to Creep' : 'Creep Resistant'}
                        </div>
                        <div class="flex items-center ${!material.Requires_Enclosure ? 'text-green-400' : 'text-yellow-400'}">
                            <span class="mr-2">${!material.Requires_Enclosure ? '‚úì' : '‚ö†'}</span> ${material.Requires_Enclosure ? 'Requires Enclosure' : 'No Enclosure Needed'}
                        </div>
                        <div class="flex items-center ${!material.Releases_Fumes ? 'text-green-400' : 'text-red-400'}">
                            <span class="mr-2">${!material.Releases_Fumes ? '‚úì' : '‚ö†'}</span> ${material.Releases_Fumes ? 'Releases Fumes' : 'Low/No Fumes'}
                        </div>
                        <div class="flex items-center ${!material.Requires_Hardened_Nozzle ? 'text-green-400' : 'text-yellow-400'}">
                            <span class="mr-2">${!material.Requires_Hardened_Nozzle ? '‚úì' : '‚ö†'}</span> ${material.Requires_Hardened_Nozzle ? 'Requires Hardened Nozzle' : 'Standard Nozzle OK'}
                        </div>
                        <div class="flex items-center text-gray-300">
                            <span class="mr-2">üìä</span> Chemical Resistance: ${material.Chemical_Resistance_Score}/5
                        </div>
                        <div class="flex items-center text-gray-300">
                            <span class="mr-2">üí∞</span> Price: ~$${material.Price_USD_per_kg}/kg
                        </div>
                    </div>
                </div>
            `;

            // Food Safety Warning/Info Box
            if (material.Food_Safe === true) {
                modalContent += `
                    <div class="bg-yellow-900/80 border-l-4 border-yellow-400 rounded-lg p-5 mb-4">
                        <div class="flex items-center mb-2">
                            <svg class="w-6 h-6 text-yellow-300 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z"/></svg>
                            <span class="text-yellow-200 font-bold text-lg">Food Safety: Read Before Use</span>
                        </div>
                        <div class="text-yellow-100 text-sm mb-2">
                            <strong>3D printed parts are rarely food safe out of the box.</strong> Even with food-safe filaments (like some PLA or PETG), bacteria can grow in layer lines, and brass nozzles may contain lead. For food contact, use a stainless steel nozzle, apply a food-safe epoxy coating, and clean thoroughly. Always check local regulations.
                        </div>
                        <div class="text-yellow-200 text-xs">
                            <a href="https://help.prusa3d.com/article/food-safe-fdm-printing_112313" target="_blank" rel="noopener noreferrer" class="underline hover:text-yellow-300">Prusa: Food Safe FDM Printing</a> &bull;
                            <a href="https://blog.prusa3d.com/how-to-make-food-grade-3d-printed-models_40666/" target="_blank" rel="noopener noreferrer" class="underline hover:text-yellow-300">How to Make Food Grade 3D Prints</a> &bull;
                            <a href="https://ultimaker.com/learn/is-pla-food-safe-a-guide-to-food-safe-3d-printing-and-filaments/" target="_blank" rel="noopener noreferrer" class="underline hover:text-yellow-300">Ultimaker: Is PLA Food Safe?</a>
                        </div>
                    </div>
                `;
            }

            // Performance Scores
            modalContent += `
                <div class="bg-gray-700 rounded-lg p-5">
                    <h3 class="text-xl font-bold text-white mb-4">Performance Scores</h3>
                    <div class="space-y-3">
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Printability</span>
                                <span class="font-bold">${material.Printability_Score}/10</span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${material.Printability_Score * 10}%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-sm mb-1">
                                <span>Cost Score (Higher = Cheaper)</span>
                                <span class="font-bold">${material.Cost_Score}/10</span>
                            </div>
                            <div class="w-full bg-gray-600 rounded-full h-2">
                                <div class="bg-green-500 h-2 rounded-full" style="width: ${material.Cost_Score * 10}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Affiliate Section (before export)
            modalContent += renderAffiliateSection(material);

            // Export Print Profiles Section (if common settings available)
            if (additionalData.common && additionalData.common.nozzle_temperature) {
                modalContent += `
                    <div class="bg-gray-700 rounded-lg p-5">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            Export Print Profile
                        </h3>
                        <p class="text-sm text-gray-400 mb-4">Download optimized print profiles for your slicer software</p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <button onclick="exportCuraProfile('${material.Material}', ${JSON.stringify(additionalData).replace(/"/g, '&quot;')})" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Cura
                            </button>
                            <button onclick="exportPrusaProfile('${material.Material}', ${JSON.stringify(additionalData).replace(/"/g, '&quot;')})" 
                                    class="bg-orange-600 hover:bg-orange-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                PrusaSlicer
                            </button>
                            <button onclick="exportOrcaProfile('${material.Material}', ${JSON.stringify(additionalData).replace(/"/g, '&quot;')})" 
                                    class="bg-purple-600 hover:bg-purple-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                OrcaSlicer
                            </button>
                            <button onclick="exportSimplify3DProfile('${material.Material}', ${JSON.stringify(additionalData).replace(/"/g, '&quot;')})" 
                                    class="bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                                </svg>
                                Simplify3D
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-3">Note: Exported profiles are starting points. Always test and adjust for your specific printer.</p>
                    </div>
                `;
            }

            // Modal footer CTAs (Support & Learn)
            modalContent += `
                <div class="bg-gray-700 rounded-lg p-5">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div>
                            <h3 class="text-xl font-bold text-white">Support & Learn</h3>
                            <p class="text-xs text-gray-400">Enjoying this tool? Support the project or watch helpful guides.</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <a href="https://ko-fi.com/minimal3dp?utm_source=app&utm_medium=modal&utm_campaign=filament_finder" target="_blank" rel="noopener noreferrer"
                               onclick="trackCtaClick('kofi','${material.Material.replace(/'/g, "\\'")}')"
                               class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-sm font-medium bg-rose-700 hover:bg-rose-600 text-white transition-colors">
                                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M3 7h14a4 4 0 110 8h-2.1A5 5 0 0110 20H5a2 2 0 01-2-2V7zm10.5 4.5c0-1.38-1.12-2.5-2.5-2.5S8.5 10.12 8.5 11.5 9.62 14 11 14s2.5-1.12 2.5-2.5z"/></svg>
                                Support on Ko‚Äëfi
                            </a>
                            <a href="https://www.youtube.com/@minimal3dp?utm_source=app&utm_medium=modal&utm_campaign=filament_finder" target="_blank" rel="noopener noreferrer"
                               onclick="trackCtaClick('youtube','${material.Material.replace(/'/g, "\\'")}')"
                               class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-sm font-medium bg-red-600 hover:bg-red-500 text-white transition-colors">
                                <svg class="w-4 h-4 mr-2" viewBox="0 0 24 24" fill="currentColor"><path d="M23.5 6.2s-.2-1.6-.8-2.4c-.7-.8-1.5-.8-1.9-.9C17.6 2.5 12 2.5 12 2.5h0s-5.6 0-8.8.4c-.4 0-1.2.1-1.9.9-.6.8-.8 2.4-.8 2.4S0 8.1 0 10v1.9c0 1.9.2 3.8.2 3.8s.2 1.6.8 2.4c.7.8 1.6.8 2 1 1.5.1 6.8.4 9 .4 0 0 5.6 0 8.8-.4.4 0 1.2-.1 1.9-.9.6-.8.8-2.4.8-2.4s.2-1.9.2-3.8V10c0-1.9-.2-3.8-.2-3.8zM9.5 14.6V7.9l6.2 3.4-6.2 3.3z"/></svg>
                                Watch on YouTube
                            </a>
                        </div>
                    </div>
                </div>
            `;

            modalBody.innerHTML = modalContent;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        }

        /**
         * Closes the material detail modal
         */
        function closeMaterialModal() {
            const modal = document.getElementById('material-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeMaterialModal();
            }
        });

        // --- FILTERING LOGIC ---

        /**
         * Main function to filter materials based on current state and re-render.
         */
        function filterAndRender() {
            // 1. Get current filter values
            const currentFilters = {
                checkboxes: {},
                sliders: {}
            };

            document.querySelectorAll('#filter-checkboxes input[type="checkbox"]').forEach(cb => {
                if (cb.checked) {
                    currentFilters.checkboxes[cb.dataset.key] = coerceType(cb.dataset.value);
                }
            });

            document.querySelectorAll('#filter-sliders input[type="range"]').forEach(slider => {
                currentFilters.sliders[slider.dataset.key] = parseFloat(slider.value);

                // Update slider value display
                document.getElementById(`val-${slider.id.split('-')[1]}`).textContent = slider.value;
            });

            // Get nozzle filter
            const nozzleSelect = document.getElementById('nozzle-select');
            const selectedNozzle = nozzleSelect.value;
            const nozzleInfoEl = document.getElementById('nozzle-info');
            
            // Show nozzle info
            if (selectedNozzle !== 'all') {
                nozzleInfoEl.textContent = nozzleInfo[selectedNozzle].description;
                nozzleInfoEl.classList.remove('hidden');
            } else {
                nozzleInfoEl.classList.add('hidden');
            }

            // Get search query
            const searchInput = document.getElementById('material-search');
            const searchQuery = searchInput.value.toLowerCase().trim();

            // 2. Apply filters
            let filteredMaterials = allMaterials.filter(material => {
                // Search filter (fuzzy match on material name and cluster)
                if (searchQuery) {
                    const materialName = material.Material.toLowerCase();
                    const cluster = material.Cluster.toLowerCase();
                    if (!materialName.includes(searchQuery) && !cluster.includes(searchQuery)) {
                        return false;
                    }
                }
                // Checkbox logic (all must match)
                for (const key in currentFilters.checkboxes) {
                    if (material[key] !== currentFilters.checkboxes[key]) {
                        return false;
                    }
                }

                // Slider logic (must be >= or <=)
                // Note: Cost is inverted (lower score is better, so we filter for <=)
                if (material.Printability_Score < currentFilters.sliders.Printability_Score) return false;
                if (material.Strength_XY_MPa < currentFilters.sliders.Strength_XY_MPa) return false;
                if (material.Heat_Resistance_HDT_C < currentFilters.sliders.Heat_Resistance_HDT_C) return false;
                if (material.Cost_Score > currentFilters.sliders.Cost_Score) return false; // Cost is max, not min

                // Nozzle compatibility filter
                if (!nozzleInfo[selectedNozzle].compatible(material)) return false;

                return true;
            });

            // 3. Sort filtered materials based on dropdown
            const sortSelect = document.getElementById('sort-select');
            const sortValue = sortSelect ? sortSelect.value : 'printability';
            filteredMaterials.sort((a, b) => {
                switch (sortValue) {
                    case 'printability':
                        return b.Printability_Score - a.Printability_Score;
                    case 'strength':
                        return b.Strength_XY_MPa - a.Strength_XY_MPa;
                    case 'heat':
                        return b.Heat_Resistance_HDT_C - a.Heat_Resistance_HDT_C;
                    case 'cost':
                        return a.Cost_Score - b.Cost_Score;
                    case 'name':
                        return String(a.Material).localeCompare(String(b.Material));
                    default:
                        return 0;
                }
            });
            renderResults(filteredMaterials);
        }

        // --- INITIALIZATION ---

        /**
         * Runs when the page is loaded.
         */
        function initialize() {
            // Parse the embedded CSV data
            allMaterials = parseCSV(csvData);

            // Sort by printability (descending) by default (for initial render)
            allMaterials.sort((a, b) => b.Printability_Score - a.Printability_Score);
            // Add event listener to sort dropdown + persist preference
            const sortSelect = document.getElementById('sort-select');
            if (sortSelect) {
                const allowedSorts = ['printability','strength','heat','cost','name'];
                const savedSort = localStorage.getItem('m3dp_sortPreference');
                if (savedSort && allowedSorts.includes(savedSort)) {
                    sortSelect.value = savedSort;
                }
                sortSelect.addEventListener('change', () => {
                    try { localStorage.setItem('m3dp_sortPreference', sortSelect.value); } catch (_) { /* no-op */ }
                    filterAndRender();
                });
            }

            // Add event listeners to all filter inputs
            const inputs = document.querySelectorAll('#filter-checkboxes input, #filter-sliders input[type="range"]');
            inputs.forEach(input => {
                input.addEventListener('input', filterAndRender);
            });

            // Add two-way binding for slider inputs
            const sliderPairs = [
                { slider: 'filter-printability', input: 'input-printability', name: 'printability' },
                { slider: 'filter-strength', input: 'input-strength', name: 'strength' },
                { slider: 'filter-heat', input: 'input-heat', name: 'heat' },
                { slider: 'filter-cost', input: 'input-cost', name: 'cost' }
            ];

            sliderPairs.forEach(pair => {
                const slider = document.getElementById(pair.slider);
                const input = document.getElementById(pair.input);
                
                // When slider moves, update input field
                slider.addEventListener('input', () => syncInputToSlider(pair.name));
                
                // When input changes, update slider
                input.addEventListener('input', () => syncSliderToInput(pair.name));
                input.addEventListener('blur', () => syncSliderToInput(pair.name));
            });

            // Add event listener to nozzle select
            const nozzleSelect = document.getElementById('nozzle-select');
            nozzleSelect.addEventListener('change', filterAndRender);

            // Add event listener to search input
            const searchInput = document.getElementById('material-search');
            searchInput.addEventListener('input', filterAndRender);

            // Annealed display toggle setup
            const annealedToggle = document.getElementById('toggle-annealed');
            try {
                const savedAnnealed = localStorage.getItem('m3dp_annealedMode');
                window.__annealedMode = savedAnnealed === 'true';
            } catch (_) { window.__annealedMode = false; }
            if (annealedToggle) {
                annealedToggle.checked = !!window.__annealedMode;
                annealedToggle.addEventListener('change', () => {
                    window.__annealedMode = annealedToggle.checked;
                    try { localStorage.setItem('m3dp_annealedMode', String(window.__annealedMode)); } catch (_) { /* no-op */ }
                    filterAndRender();
                    // If compare view is open, refresh it
                    const compareView = document.getElementById('compare-view');
                    if (compareView && !compareView.classList.contains('hidden')) {
                        renderCompareTable();
                    }
                });
            }

            // View mode setup
            try {
                const savedView = localStorage.getItem('m3dp_viewMode');
                if (savedView === 'compact' || savedView === 'detailed') viewMode = savedView;
            } catch (_) { /* no-op */ }
            updateViewToggleUI();
            const viewDetailedBtn = document.getElementById('view-detailed-btn');
            const viewCompactBtn = document.getElementById('view-compact-btn');
            if (viewDetailedBtn) viewDetailedBtn.addEventListener('click', () => setViewMode('detailed'));
            if (viewCompactBtn) viewCompactBtn.addEventListener('click', () => setViewMode('compact'));

            // Initial render with all materials
            filterAndRender();

            // Compare bar actions
            const compareBtn = document.getElementById('compare-btn');
            const clearCompareBtn = document.getElementById('clear-compare-btn');
            const closeCompareBtn = document.getElementById('close-compare-btn');
            if (compareBtn) compareBtn.addEventListener('click', openCompareView);
            if (clearCompareBtn) clearCompareBtn.addEventListener('click', () => { selectedForCompare = []; updateCompareBar(); filterAndRender(); });
            if (closeCompareBtn) closeCompareBtn.addEventListener('click', closeCompareView);
        }

        // --- COMPARE FUNCTIONS ---
        function toggleCompareSelection(materialName, checked) {
            const idx = selectedForCompare.indexOf(materialName);
            if (checked) {
                if (idx === -1) {
                    if (selectedForCompare.length >= 4) {
                        // revert selection and inform user
                        updateCompareBar();
                        alert('You can compare up to 4 materials.');
                        return;
                    }
                    selectedForCompare.push(materialName);
                }
            } else {
                if (idx !== -1) selectedForCompare.splice(idx, 1);
            }
            updateCompareBar();
        }

        function updateCompareBar() {
            const bar = document.getElementById('compare-bar');
            const countEl = document.getElementById('compare-count');
            if (!bar || !countEl) return;
            countEl.textContent = String(selectedForCompare.length);
            if (selectedForCompare.length >= 1) {
                bar.classList.remove('hidden');
            } else {
                bar.classList.add('hidden');
                closeCompareView();
            }
        }

        function openCompareView() {
            if (selectedForCompare.length < 2) { alert('Select at least 2 materials to compare.'); return; }
            renderCompareTable();
            const view = document.getElementById('compare-view');
            if (view) view.classList.remove('hidden');
            // optional: scroll into view
            try { view.scrollIntoView({ behavior: 'smooth', block: 'start' }); } catch (_) { /* no-op */ }
        }

        function closeCompareView() {
            const view = document.getElementById('compare-view');
            if (view) view.classList.add('hidden');
        }

        function getCompareValue(m, key) {
            if (!window.__annealedMode || !m?.Annealable_for_HDT) return m[key];
            if (key === 'Strength_XY_MPa') return (m.Strength_XY_MPa_Annealed ?? m[key]);
            if (key === 'Heat_Resistance_HDT_C') return (m.Heat_Resistance_HDT_Annealed_C ?? m[key]);
            return m[key];
        }

        function renderCompareTable() {
            const body = document.getElementById('compare-table-body');
            if (!body) return;
            const selected = allMaterials.filter(m => selectedForCompare.includes(m.Material)).slice(0, 4);
            // Update header hint badge visibility
            const hintEl = document.getElementById('compare-mode-hint');
            const dualModeFlag = !!window.__annealedMode;
            if (hintEl) {
                if (dualModeFlag) {
                    hintEl.textContent = 'Dual view: As‚ÄëPrinted + Annealed';
                    hintEl.classList.remove('hidden');
                } else {
                    hintEl.classList.add('hidden');
                }
            }

            // Helper to build a numeric row with highlight for min/max
            function buildNumericRow(label, values, higherBetter = true, suffix = '') {
                // compute min/max indexes among defined numeric values
                const numeric = values.map(v => (typeof v === 'number' ? v : null));
                let min = Infinity, max = -Infinity, minIdx = -1, maxIdx = -1;
                numeric.forEach((v, i) => {
                    if (v === null) return;
                    if (v < min) { min = v; minIdx = i; }
                    if (v > max) { max = v; maxIdx = i; }
                });
                return `<tr class="border-t border-gray-700">
                    <td class="px-4 py-2 text-gray-200 font-medium">${label}</td>
                    ${[0,1,2,3].map(i => {
                        const v = values[i];
                        const hasNum = typeof v === 'number';
                        let cls = 'px-4 py-2';
                        if (hasNum) {
                            if (higherBetter && i === maxIdx) cls += ' bg-green-900/40';
                            if (!higherBetter && i === minIdx) cls += ' bg-green-900/40';
                        }
                        const text = (v === undefined || v === null || v === '') ? '‚Äî' : `${v}${suffix}`;
                        return `<td class="${cls}">${text}</td>`;
                    }).join('')}
                </tr>`;
            }

            // Static/basic rows first
            let html = '';
            // Material
            html += `<tr class="border-t border-gray-700">
                <td class="px-4 py-2 text-gray-200 font-medium">Material</td>
                ${[0,1,2,3].map(i => `<td class="px-4 py-2">${selected[i]?.Material || ''}</td>`).join('')}
            </tr>`;
            // Cluster
            html += `<tr class="border-t border-gray-700">
                <td class="px-4 py-2 text-gray-200 font-medium">Cluster</td>
                ${[0,1,2,3].map(i => `<td class="px-4 py-2">${selected[i]?.Cluster || ''}</td>`).join('')}
            </tr>`;
            // Printability
            html += buildNumericRow('Printability (0-10)', selected.map(m => m?.Printability_Score), true);

            const dualMode = !!window.__annealedMode;
            if (dualMode) {
                // Strength XY: As-Printed
                html += buildNumericRow('Strength XY (MPa) ‚Äî As‚ÄëPrinted', selected.map(m => m?.Strength_XY_MPa), true, '');
                // Strength XY: Annealed (if any data)
                const hasAnnealedStrength = selected.some(m => m && m.Annealable_for_HDT && (m.Strength_XY_MPa_Annealed ?? '') !== '');
                if (hasAnnealedStrength) {
                    html += buildNumericRow('Strength XY (MPa) ‚Äî Annealed', selected.map(m => (m?.Annealable_for_HDT ? (m.Strength_XY_MPa_Annealed || null) : null)), true, '');
                }

                // HDT: As-Printed
                html += buildNumericRow('HDT (¬∞C) ‚Äî As‚ÄëPrinted', selected.map(m => m?.Heat_Resistance_HDT_C), true, '');
                // HDT: Annealed (if any data)
                const hasAnnealedHDT = selected.some(m => m && m.Annealable_for_HDT && (m.Heat_Resistance_HDT_Annealed_C ?? '') !== '');
                if (hasAnnealedHDT) {
                    html += buildNumericRow('HDT (¬∞C) ‚Äî Annealed', selected.map(m => (m?.Annealable_for_HDT ? (m.Heat_Resistance_HDT_Annealed_C || null) : null)), true, '');
                }
            } else {
                // Single-row view when toggle is off (as-printed values only)
                html += buildNumericRow('Strength XY (MPa)', selected.map(m => m?.Strength_XY_MPa), true, '');
                html += buildNumericRow('HDT (¬∞C)', selected.map(m => m?.Heat_Resistance_HDT_C), true, '');
            }

            // Cost Score
            html += buildNumericRow('Cost Score (1-10)', selected.map(m => m?.Cost_Score), false);

            // Booleans
            function buildBooleanRow(label, getter) {
                return `<tr class="border-t border-gray-700">
                    <td class="px-4 py-2 text-gray-200 font-medium">${label}</td>
                    ${[0,1,2,3].map(i => {
                        const v = getter(selected[i]);
                        return `<td class="px-4 py-2">${v === undefined || v === null ? '' : (v ? 'Yes' : 'No')}</td>`;
                    }).join('')}
                </tr>`;
            }
            html += buildBooleanRow('UV Resistant', (m) => m?.UV_Resistant);
            html += buildBooleanRow('Hygroscopic', (m) => m?.Hygroscopic);
            html += buildBooleanRow('Requires Enclosure', (m) => m?.Requires_Enclosure);
            html += buildBooleanRow('Abrasive (Hardened Nozzle)', (m) => m?.Requires_Hardened_Nozzle);

            body.innerHTML = html;
        }

        // --- FILTER UI FUNCTIONS ---

        /**
         * Reset all filters to default state
         */
        function resetAllFilters() {
            // Uncheck all checkboxes
            document.querySelectorAll('#filter-checkboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });

            // Reset all sliders to default values
            document.getElementById('filter-printability').value = 1;
            document.getElementById('filter-strength').value = 0;
            document.getElementById('filter-heat').value = 0;
            document.getElementById('filter-cost').value = 10;

            // Reset all input fields to match sliders
            document.getElementById('input-printability').value = 1;
            document.getElementById('input-strength').value = 0;
            document.getElementById('input-heat').value = 0;
            document.getElementById('input-cost').value = 10;

            // Reset nozzle filter
            document.getElementById('nozzle-select').value = 'all';

            // Clear search
            document.getElementById('material-search').value = '';

            // Re-render
            filterAndRender();
        }

        /**
         * Snap a slider to a specific common value
         */
        function snapToValue(filterName, value) {
            const slider = document.getElementById(`filter-${filterName}`);
            const input = document.getElementById(`input-${filterName}`);
            slider.value = value;
            input.value = value;
            filterAndRender();
        }

        /**
         * Sync slider with input field (two-way binding)
         */
        function syncSliderToInput(filterName) {
            const slider = document.getElementById(`filter-${filterName}`);
            const input = document.getElementById(`input-${filterName}`);
            
            // Ensure value is within bounds
            let value = parseInt(input.value);
            if (isNaN(value)) value = parseInt(slider.min);
            value = Math.max(parseInt(slider.min), Math.min(parseInt(slider.max), value));
            
            slider.value = value;
            input.value = value;
            filterAndRender();
        }

        /**
         * Sync input field with slider (two-way binding)
         */
        function syncInputToSlider(filterName) {
            const slider = document.getElementById(`filter-${filterName}`);
            const input = document.getElementById(`input-${filterName}`);
            input.value = slider.value;
        }

        /**
         * Apply preset filter configurations
         */
        function applyPreset(presetName) {
            // First reset all filters
            resetAllFilters();

            const presets = {
                'beginner': {
                    checkboxes: { 'filter-enclosure': true, 'filter-fumes': true },
                    sliders: { 'filter-printability': 7, 'filter-cost': 6 }
                },
                'outdoor': {
                    checkboxes: { 'filter-uv': true },
                    sliders: { 'filter-printability': 5 }
                },
                'engineering': {
                    // High strength and heat resistance
                    // Removed moisture filter as Nylon is hygroscopic but still engineering grade
                    sliders: { 'filter-strength': 50, 'filter-heat': 80 }
                },
                'flexible': {
                    // Search for materials with "Flexible" in the name (TPU variants)
                    search: 'Flexible'
                }
            };

            const preset = presets[presetName];
            if (!preset) return;

            // Apply search query if specified
            if (preset.search) {
                const searchInput = document.getElementById('material-search');
                searchInput.value = preset.search;
            }

            // Apply checkbox settings
            if (preset.checkboxes) {
                for (const [id, value] of Object.entries(preset.checkboxes)) {
                    const checkbox = document.getElementById(id);
                    if (checkbox) checkbox.checked = value;
                }
            }

            // Apply slider settings
            if (preset.sliders) {
                for (const [id, value] of Object.entries(preset.sliders)) {
                    const slider = document.getElementById(id);
                    if (slider) {
                        slider.value = value;
                        // Also update corresponding input field
                        const filterName = id.replace('filter-', '');
                        const input = document.getElementById(`input-${filterName}`);
                        if (input) input.value = value;
                    }
                }
            }

            // Re-render with new settings
            filterAndRender();
        }

        // --- EXPORT FUNCTIONS ---

        /**
         * Utility function to download a file
         */
        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * Export Cura profile (.ini format)
         */
        function exportCuraProfile(materialName, data) {
            const common = data.common;
            const material = materialName.replace(/[^a-zA-Z0-9]/g, '_');
            
            const profile = `[general]
version = 4
name = ${materialName}
definition = fdmprinter

[metadata]
type = quality_changes
quality_type = normal
setting_version = 20

[values]
material_print_temperature = ${common.nozzle_temperature}
material_bed_temperature = ${common.bed_temperature}
speed_print = ${common.print_speed}
cool_fan_speed = ${common.fan_speed}
${common.retraction_distance_mm ? `retraction_amount = ${common.retraction_distance_mm}` : ''}
${common.retraction_speed_mm_s ? `retraction_speed = ${common.retraction_speed_mm_s}` : ''}
${common.first_layer_speed_pct ? `speed_layer_0 = ${common.print_speed * common.first_layer_speed_pct / 100}` : ''}
layer_height = 0.2
wall_thickness = 1.2
infill_sparse_density = 20
`;

            downloadFile(profile, `${material}_cura_profile.ini`, 'text/plain');
        }

        /**
         * Export PrusaSlicer profile (.ini format)
         */
        function exportPrusaProfile(materialName, data) {
            const common = data.common;
            const material = materialName.replace(/[^a-zA-Z0-9]/g, '_');
            
            const profile = `# generated by M3DP Filament Recommendation Engine
# ${new Date().toISOString()}

[print:${materialName}]
compatible_printers = 
compatible_printers_condition = 
inherits = 
temperature = ${common.nozzle_temperature}
bed_temperature = ${common.bed_temperature}
bridge_fan_speed = ${common.fan_speed}
fan_always_on = ${common.fan_speed > 0 ? '1' : '0'}
max_fan_speed = ${common.fan_speed}
min_fan_speed = ${Math.max(0, common.fan_speed - 20)}
${common.retraction_distance_mm ? `retract_length = ${common.retraction_distance_mm}` : ''}
${common.retraction_speed_mm_s ? `retract_speed = ${common.retraction_speed_mm_s}` : ''}
perimeter_speed = ${common.print_speed}
external_perimeter_speed = ${Math.round(common.print_speed * 0.8)}
infill_speed = ${common.print_speed}
${common.first_layer_speed_pct ? `first_layer_speed = ${common.print_speed * common.first_layer_speed_pct / 100}` : ''}
layer_height = 0.2
fill_density = 20%
`;

            downloadFile(profile, `${material}_prusa_profile.ini`, 'text/plain');
        }

        /**
         * Export OrcaSlicer profile (.json format)
         */
        function exportOrcaProfile(materialName, data) {
            const common = data.common;
            const material = materialName.replace(/[^a-zA-Z0-9]/g, '_');
            
            const profileData = {
                "name": materialName,
                "from": "User",
                "version": "1.9.0.0",
                "filament_type": [materialName.split(' ')[0]],
                "instantiation": "true",
                "inherits": "",
                "temperature": [common.nozzle_temperature.toString()],
                "bed_temperature": [common.bed_temperature.toString()],
                "fan_min_speed": [Math.max(0, common.fan_speed - 20).toString()],
                "fan_max_speed": [common.fan_speed.toString()],
                "fan_always_on": [common.fan_speed > 0 ? "1" : "0"],
                "retract_length": [common.retraction_distance_mm ? common.retraction_distance_mm.toString() : "5"],
                "retract_speed": [common.retraction_speed_mm_s ? common.retraction_speed_mm_s.toString() : "45"],
                "deretract_speed": [common.retraction_speed_mm_s ? (common.retraction_speed_mm_s * 0.8).toString() : "40"],
                "outer_wall_speed": [common.print_speed.toString()],
                "inner_wall_speed": [(common.print_speed * 1.2).toString()],
                "sparse_infill_speed": [common.print_speed.toString()],
                "initial_layer_speed": [common.first_layer_speed_pct ? (common.print_speed * common.first_layer_speed_pct / 100).toString() : (common.print_speed * 0.5).toString()],
                "initial_layer_print_height": ["0.2"],
                "layer_height": ["0.2"],
                "sparse_infill_density": ["20%"],
                "wall_loops": ["2"],
                "top_shell_layers": ["4"],
                "bottom_shell_layers": ["3"]
            };
            
            const profile = JSON.stringify(profileData, null, 2);
            downloadFile(profile, `${material}_orca_profile.json`, 'application/json');
        }

        /**
         * Export Simplify3D profile (.fff XML format)
         */
        function exportSimplify3DProfile(materialName, data) {
            const common = data.common;
            const material = materialName.replace(/[^a-zA-Z0-9]/g, '_');
            
            const profile = `<?xml version="1.0"?>
<profile name="${materialName}" version="1.0.0">
  <baseProfile>Default</baseProfile>
  <printMaterial>${materialName}</printMaterial>
  <printQuality>Medium</printQuality>
  
  <extruder name="Primary Extruder">
    <toolheadNumber>0</toolheadNumber>
    <diameter>0.4</diameter>
    <autoWidth>1</autoWidth>
    <width>0.48</width>
    
    <extrusionMultiplier>1</extrusionMultiplier>
    <extrusionWidth>0</extrusionWidth>
    <useRetract>1</useRetract>
    <retractionDistance>${common.retraction_distance_mm || 5}</retractionDistance>
    <retractionSpeed>${(common.retraction_speed_mm_s || 45) * 60}</retractionSpeed>
    <retractionZLift>0</retractionZLift>
  </extruder>
  
  <primaryLayerHeight>0.2</primaryLayerHeight>
  <firstLayerHeightPercentage>${common.first_layer_speed_pct || 100}</firstLayerHeightPercentage>
  
  <defaultSpeed>${common.print_speed * 60}</defaultSpeed>
  <outlineUnderspeed>0.8</outlineUnderspeed>
  <firstLayerUnderspeed>0.5</firstLayerUnderspeed>
  
  <temperature name="Extruder 1">${common.nozzle_temperature}</temperature>
  <temperatureSetpointCount>1</temperatureSetpointCount>
  
  <temperatureName>Heated Bed</temperatureName>
  <temperatureNumber>0</temperatureNumber>
  <temperatureSetpoint layer="1" temperature="${common.bed_temperature}"/>
  
  <fanSpeed>
    <setpoint layer="1" speed="${common.fan_speed}"/>
  </fanSpeed>
  
  <infillPercentage>20</infillPercentage>
  <infillExtruder>0</infillExtruder>
  <infillType>Rectilinear</infillType>
  
  <topSolidLayers>4</topSolidLayers>
  <bottomSolidLayers>3</bottomSolidLayers>
  <outlinePerimeters>2</outlinePerimeters>
</profile>`;

            downloadFile(profile, `${material}_simplify3d_profile.fff`, 'application/xml');
        }

        // 5. Start the application
        document.addEventListener('DOMContentLoaded', initialize);
        // Defer GA load to idle time for performance
        if (window.requestIdleCallback) { requestIdleCallback(loadGA); } else { setTimeout(loadGA, 0); }

    </script>
</body>

</html>